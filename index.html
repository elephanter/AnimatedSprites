<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Crona games</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <script src="libs/loadImage.js"></script>
     <style>
     body{color: #61443e;}
     #gameCanvas {
    width: 1200px;
    height: 600px;
    border: 1px solid #ccc;
}
</style>
  </head>

  <body>
    <div id="bdy"></div>

    <div class="container-narrow">
    <h2>
    <a hrev="https://github.com/elephanter/AnimatedSprites">Github repo</a> - <a hrev="http://elephanter.github.io/AnimatedSprites/test.html">Performance test</a>
    </h2>
      <div class="row-fluid marketing">
        <div class="span12"style="padding-top:50px">
        <center >
        <!--  <canvas id="gameCanvas" width="1200" height="600"></canvas>-->
        <div id="container"></div>
      </center>
          <div id="fps"> </div>
          <p>
            <a href="/">Back</a>
          </p>
        </div>
      </div>

      <hr>

      <div class="footer">
        <p>&copy; Crona Games 2013</p>
      </div>

    </div> <!-- /container -->
    <input type="file" name="somename" id="hiddenInput" style="display:none">

    <!-- Le javascript <script stype="text/javascript" src="{% static "js/libs/requirejs_2_1_5_min.js" %}" charset="utf-8"></script>
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="libs/underscore.js"></script>
    <script type="text/javascript" src="libs/jquery.js"></script>
    <script type="text/javascript" src="libs/dat_gui.js"></script>
    <script type="text/javascript" src="libs/dat_color.js"></script>
    <script type="text/javascript" src="libs/three.js"></script>
    <script type="text/javascript" src="libs/stats.js"></script>
    <script type="text/javascript" src="AnimatedSprites.js"></script>
    <script type="text/javascript" src="libs/FlyControls.js"></script>

<script type="text/javascript">


            var controls,time = Date.now();
            var SPRITE_IMAGE = new Image();
            var SPRITE_PLANE = null;
        //PROJECT SETTINGS
            var settings = {
                frameWidth: 32,
                frameHeight: 32,
                framesCount: 3,
                animationSpeed: 1000,
                offsetX: 0,
                offsetY: 0,
                rotationAroundX: 0,
                spriteRotation: 0,
                spriteFile: function(){
                    $("#hiddenInput").click();
                }
            };
            function onSettingsChanged() {
                SPRITE_PLANE.changeOptions(getSettingsSpriteParams());
                //refreshAnimation(SPRITE_IMAGE);
            };
            function onSizeChanged() {
                SPRITE_PLANE.changeSprite("walk", {noCache: true, newSpriteParams: getSettingsSpriteParams()});
                //refreshAnimation(SPRITE_IMAGE);
            };
            function getSettingsSpriteParams(){
                return {
                            offset:[settings.offsetX,settings.offsetY],
                            size:[settings.frameWidth*settings.framesCount, settings.frameHeight],
                            frameWidth: settings.frameWidth,
                            frameHeight: settings.frameHeight,
                            framesCount: settings.framesCount,
                            speed: settings.animationSpeed,
                            rotationAroundX: settings.rotationAroundX,
                            spriteRotation: settings.spriteRotation
                        };
            }

            var gui = new dat.GUI();
            gui.add( settings, 'spriteFile' );
            gui.add( settings, 'frameWidth' ).min( 16 ).max( 128 ).onChange( onSizeChanged );
            gui.add( settings, 'frameHeight' ).min( 16 ).max( 128 ).onChange( onSizeChanged );
            gui.add( settings, 'framesCount' ).min( 1 ).max( 20 ).onChange( onSizeChanged );
            gui.add( settings, 'animationSpeed' ).min( 200 ).max( 5000 ).onChange( onSettingsChanged );
            gui.add( settings, 'offsetX' ).min( 0 ).max( 1024 ).onChange( onSizeChanged );
            gui.add( settings, 'offsetY' ).min( 0 ).max( 1024 ).onChange( onSizeChanged );
            gui.add( settings, 'rotationAroundX' ).min( 0 ).max( 360 ).onChange( onSizeChanged );
            gui.add( settings, 'spriteRotation' ).min( 0 ).max( 360 ).onChange( onSizeChanged );
            // gui.add( settings, 'gravity' ).min( -3.0 ).max( 3.0 ).onChange( onSettingsChanged );
            // gui.add( settings, 'wind' ).min( -3.0 ).max( 3.0 ).onChange( onSettingsChanged );
            // gui.add( settings, 'friction' ).min( 0.0 ).max( 1.0 ).onChange( onSettingsChanged );

            // var colourGUI = gui.addColor( settings, 'colour' );
            // gui.add( settings, 'darkTheme' ).onChange( onThemeChanged );
            // gui.add( settings, 'pulse' );

            // var interactiveGUI = gui.add( settings, 'interactive' );

            // // gui.add( sketch, 'save' );
            // gui.close();
            // //Eof project settings

function refreshAnimation(image){
    if (SPRITE_PLANE) scene.remove(SPRITE_PLANE);
    var sprGroup = new THREE.AnimatedSprites.SpritesGroup(image, {
                            sprites:{
                                walk: getSettingsSpriteParams()
                            }
                        }
                );
    SPRITE_PLANE = sprGroup.getNewSprite("walk",{position: new THREE.Vector3(40,40,40)});
    scene.add(SPRITE_PLANE);
}


var scene;

$(function(){
    //local image loader
        document.getElementById('hiddenInput').onchange = function (e) {
            var file = (e.dataTransfer || e.target).files[0];
            window.loadImage.readFile(
                file,
                function (e) {
                    var loadingImage = window.loadImage(
                        file,
                        function (img) {
                            SPRITE_IMAGE = img;
                            refreshAnimation(SPRITE_IMAGE);
                        },
                        {maxWidth: 600}
                    );
                },
                'readAsArrayBuffer'
            );
        };
    //------------------------------

    var stats = new Stats();
                    stats.domElement.style.position = 'absolute';
                    stats.domElement.style.top = '0px';
                    container.appendChild( stats.domElement );
            // set the scene size
    var WIDTH = 800,
      HEIGHT = 600;

    // set some camera attributes
    var VIEW_ANGLE = 90,
      ASPECT = WIDTH / HEIGHT,
      NEAR = 0.1,
      FAR = 10000;

    var $container = $('#container');
    var renderer = new THREE.WebGLRenderer();
    scene = new THREE.Scene();

    var camera =
      new THREE.PerspectiveCamera(
        VIEW_ANGLE,
        ASPECT,
        NEAR,
        FAR);


    scene.fog = new THREE.FogExp2( 0xffffff, 0.00015 );


    var ambientLight = new THREE.AmbientLight( 0xcccccc );



    //DEBUG
        var object= new THREE.AxisHelper(10000);
        object.position.set( 40, 40, 40 );
        scene.add(object);


    renderer.setSize(WIDTH, HEIGHT);
    $container.append(renderer.domElement);

    controls = new THREE.FlyControls(camera,renderer.domElement);
    controls.dragToLook =true;

    camera.position.set( 50, 50, 300 );
    camera.lookAt( scene.position );

    scene.add(camera);
    scene.add( ambientLight );


  var startImage = new Image();
  startImage.onload = function(){
    SPRITE_IMAGE = startImage;
    refreshAnimation(startImage);
  };
  startImage.src = "img/testsprites.png";
render();
    function render() {
            requestAnimationFrame( render );
            var delta = new Date().getTime()-time;
            THREE.AnimatedSprites.update(delta);

            controls.update(delta)
            renderer.render(scene, camera);
            stats.update();

            time = new Date().getTime();
     }
});
    </script>
  </body>
</html>
